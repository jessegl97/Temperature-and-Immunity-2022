labs(x="Treatment x Temp", y= "Magnitude of Fever Change (Peak - Baseline)", color="Treatment")+
scale_color_manual(values=c(treat_colors))+
theme(
axis.text.x = element_text(angle = 45, hjust=1),
legend.position = "right",
legend.direction = "vertical"
)
#emmeans
emm <-emmeans(lm3, ~temp+treatment)
tests <- contrast(emm, method = "pairwise", adjust = "tukey")
emm_df <- as.data.frame(emm)  # has emmean, SE, lower.CL, upper.CL
emm_df <- emm_df %>%
mutate(
treat.temp = interaction(treatment, temp, drop = TRUE),
# make sure the level order matches your plotting data
treat.temp = factor(treat.temp, levels = levels(ti.long$treat.temp))
)
ggplot(ti.fc, aes(x=treat.temp, y=mag_high, color = treat.temp))+
geom_jitter(width = 0.1, height=0, shape =16, size=3)+
geom_point(data=emm_df, aes(y=emmean, x=treat.temp), color="black", size=3)+
geom_errorbar(data=emm_df, aes(y=emmean, ymin=lower.CL, ymax=upper.CL, x=treat.temp), width=0.1, color="black")+
labs(x="Treatment x Temp", y= "Magnitude of Fever Change (Peak - Baseline)", color="Treatment")+
scale_color_manual(values=c(treat_colors))+
theme(
axis.text.x = element_text(angle = 45, hjust=1),
legend.position = "right",
legend.direction = "vertical"
)
# tidy or convert results
lm3_coef_fixed   <- broom.mixed::tidy(lm3, effects = "fixed", conf.int = TRUE)
lm3_coef_random  <- broom.mixed::tidy(lm3, effects = "ran_pars", conf.int = TRUE)
lm3_fit_glance   <- broom.mixed::glance(lm3)
lm3_anova_II_df  <- broom::tidy(lm3_anova_II)
lm3_anova_III_df <- broom::tidy(lm3_anova_III)
lm3_emm_df       <- as.data.frame(emm)
lm3_pairs_temp_df     <- as.data.frame(pairs(emm, by = c("temp"), adjust = "tukey"))
lm3_pairs_treatment_df     <- as.data.frame(pairs(emm, by = c("treatment"), adjust = "tukey"))
# combine into one named list
lm3_out_list <- list(
"Model_Fixed_Coeffs"     = lm3_coef_fixed,
"Model_Random_Vars"      = lm3_coef_random,
"Model_Fit_Summary"      = lm3_fit_glance,
"ANOVA_Type_II"          = lm3_anova_II_df,
"ANOVA_Type_III"         = lm3_anova_III_df,
"Estimated_Marginal_Means" = lm3_emm_df,
"Pairwise_Comparisons_Temp"   = lm3_pairs_temp_df,
"Pairwise_Comparisons_Treatment"   = lm3_pairs_treatment_df
)
#Model Predictions > lm only so different
mod <- lm3
# build prediction grid from the same factor levels
dat.new <- ti.fc %>%
distinct(temp, treatment) %>%
mutate(treat.temp = interaction(treatment, temp, drop = TRUE),
treat.temp = factor(treat.temp, levels = levels(ti.fc$treat.temp)))
# predictions (confidence interval for the mean)
pr <- predict(lm3, newdata = dat.new, se.fit = TRUE)
dat.new <- dat.new %>%
mutate(
yhat = pr$se.fit*0 + pr$fit,     # just to keep the naming obvious
Lower  = pr$fit - 1.96 * pr$se.fit,
Upper  = pr$fit + 1.96 * pr$se.fit
)
#Model Predictions
ggplot(ti.fc, aes(x=treat.temp, y=mag_high, color = treat.temp))+
geom_jitter(width = 0.1, height=0, shape =16, size=2)+
geom_point(data=dat.new, aes(y=yhat, x=treat.temp), color="black")+
geom_errorbar(data=dat.new, aes(y=yhat, ymin=Lower, ymax=Upper, x=treat.temp), width=0.1, color="black")+
labs(x="Treatment x Temp", y= "Magnitude of Fever Change (Peak - Baseline)", color="Treatment")+
scale_color_manual(values=c(treat_colors))+
theme(
axis.text.x = element_text(angle = 45, hjust=1),
legend.position = "right",
legend.direction = "vertical"
)
#####Eye Score####
source("dataCleaning_TI22.R")
range(ti.cont$quantity) #highest control quantity = 95.38
ti$quant_cutoff = 100
ti$seropos_cutoff = 0.061
ti$sympt_cutoff = 0.1
#Sample sizes
ti %>%
filter(dpi ==0)%>%
dplyr::select(treatment, temp, inf_temp)%>%
tbl_summary(
)%>%
modify_header(
label ~ "**All Birds**"
)
ti %>%
dplyr::select(dpi, treatment, temp, inf_temp)%>%
tbl_summary(
by=dpi
)%>%
modify_header(
label ~ "**All Days**"
)
#data frame with only inoculated birds on days with eye scores
ti.inoc <- ti%>%
filter(treatment == "Inoculated" & dpi %in% c(0, 3,7,9,14,18,21,24,28,35))
hist(ti.inoc$total_eye_score)
hist(ti$total_eye_score)
ti.inoc$sympt_cutoff = 0.5
ti.inoc$quant_cutoff = 22.5
#diseased = eye score
#infected = eye score or pathology >= cutoff
ti.inoc <- ti.inoc %>%
mutate(diseased= ifelse(total_eye_score>=sympt_cutoff, 1, 0),
sick = ifelse(total_eye_score>=sympt_cutoff | quantity >= quant_cutoff, 1, 0),
infected = ifelse(quantity >= quant_cutoff, 1, 0))
#new column with whether the bird is ever diseased
ti.inoc <- ti.inoc %>%
group_by(band_number) %>%
mutate(ever_diseased = ifelse(any(coalesce(diseased, 0) == 1), 1, 0),
ever_infected = ifelse(any(coalesce(infected, 0) == 1), 1, 0),
ever_sick = ifelse(any(coalesce(sick, 0) == 1), 1,0))%>%
ungroup()
#Sample sizes
#ever_diseased: cold n=6, warm n=8
#ever_infected: cold n=12, warm n=13
#Asymptomatic: cold n=6, warm n=5
ti.inoc %>%
filter(dpi ==28)%>%
dplyr::select(temp, ever_diseased, ever_infected, ever_sick)%>%
tbl_summary(
by=temp
)%>%
modify_header(
label ~ "**Inoculated Birds**"
)
#Source Eye Score Formatting
source("dataCleaning_eyeScore.R")
#Ordinal Mixed Effects Model
#Sham birds did not get infected therefore did not have eyescores. Remove from analysis so that model converges.
#No eye score on DPI 3 so also remove. Keep DPI 0 as reference category.
ti.mod <- ti %>%
dplyr::select(date, dpi, band_number, bird_ID, treatment, temp, total_eye_score)%>%
filter(treatment != "Sham" & dpi %in% c(0, 7,9,14,18,21,24,28))%>%
mutate(temp = relevel(factor(temp), ref = "Warm"),
dpi_f  = factor(dpi, levels = c(0,7,9,14,18,21,24,28)))
#We need to define thresholds based off of the observed data. The technical bounds are [0,6], but we only have [0,4]
levels_obs <- sort(unique(ti.mod$total_eye_score))
#turn observed numeric scores into an ordered factor with factors
ti.mod$eye_score_ord <- ordered(
ti.mod$total_eye_score,
levels=levels_obs
)
with(ti.mod, xtabs(~ eye_score_ord + temp + dpi_f))
ti.mod <- ti.mod |>
mutate(eye5 = fct_collapse(eye_score_ord,
"0"="0",
"1"=c("0.5","1"),
"2"=c("1.5","2"),
"3"=c("2.5","3"),
"4"=c("3.5","4")))
ti.mod <- ti.mod %>%
mutate(
dpi_f = relevel(dpi_f, ref = "0"),
temp  = relevel(temp,  ref = "Warm")
)
#Model Comparisons
clm.a <- clmm(eye_score_ord ~ temp * dpi_f + (1|band_number),
data=ti.mod,
link = "logit")
clm.b <- clmm(eye5 ~ temp * dpi_f + (1|band_number),
data=ti.mod,
link = "logit")
clm.c <- clmm(eye_score_ord ~ temp + dpi_f + (1|band_number),
data=ti.mod,
link = "logit")
clm.d <- clmm(eye5 ~ temp + dpi_f + (1|band_number),
data=ti.mod,
link = "logit")
summary(clm.a)
summary(clm.b)
summary(clm.c)
summary(clm.d)
aictab(cand.set=list(clm.a, clm.c),
modnames= c("clm.a", "clm.c"))
aictab(cand.set=list(clm.b, clm.d),
modnames= c("clm.b", "clm.d"))
#can't directly compare, but lower AIC = good
AIC(clm.c, clm.d)
#Lower logLikelihood = good
logLik(clm.c)
logLik(clm.d)
#R2 same if not slightly better = good
r2_nakagawa(clm.c)
r2_nakagawa(clm.d)
#predictions look the same
emmip(clm.c, temp ~ dpi_f)
emmip(clm.d, temp ~ dpi_f)
#use eye5 in final model
clm1 <- clmm(eye5 ~ temp + dpi_f + (1|band_number),
data=ti.mod,
link = "logit")
summary(clm1)
ti.mod <- ti.mod %>%
mutate(
eye5_num = as.numeric(as.character(eye5)),               # 0..4
dpi_num  = as.numeric(as.character(dpi_f))               # e.g., 0,7,9,14,...
)
# 2) Model predictions: expected category (mean class) + 95% CIs
emm_mean <- emmeans(clm1, ~ temp * dpi_f,
type = "response", mode = "mean.class") |>
as.data.frame() |>
mutate(
yhat = estimate - 1,
ymin = asymp.LCL - 1,
ymax = asymp.UCL - 1,
dpi_num = as.numeric(as.character(dpi_f))
)
ggplot() +
# raw observations
geom_jitter(
data = ti.mod,
aes(x = dpi_num, y = eye5_num, color = temp),
width = 0.6, height = 0.08, alpha = 0.35, size = 1.7
) +
# model mean class with CI
geom_errorbar(
data = emm_mean,
aes(x = dpi_num, ymin = ymin, ymax = ymax, color = temp),
width = 0.8, size = 0.5
) +
geom_line(
data = emm_mean,
aes(x = dpi_num, y = yhat, color = temp, group = temp),
size = 0.7
) +
geom_point(
data = emm_mean,
aes(x = dpi_num, y = yhat, color = temp),
size = 2.5
) +
scale_y_continuous(breaks = 0:4, limits = c(-1, 4.1)) +
labs(x = "Days Post Inoculation", y = "Total Eye Score",
color = "Temperature") +
theme_minimal(base_size = 12)
ggplot(ti.inoc, aes(x=dpi, y=total_eye_score, color=temp))+
geom_jitter(width=0.5, height=0.1, alpha=0.25)+
#geom_line(aes(group = band_number), alpha=0.25)+
stat_summary(aes(x=dpi, y=total_eye_score, color = temp), geom = "point", size=3)+
stat_summary(aes(x=dpi, y=total_eye_score, color = temp), geom = "errorbar", width=0.5)+
stat_summary(aes(x=dpi, y=total_eye_score, color = temp), geom = "line", width=0.25, alpha=0.5)+
scale_color_manual(values = temp_colors)+
labs(x="Days Post Inoculation", y="Total Eye Score", color="Temperature")
ggplot(ti.inoc, aes(x=dpi, y=total_eye_score, color=temp))+
geom_jitter(width=0.5, height=0.1, alpha=0.25)+
#geom_line(aes(group = band_number), alpha=0.25)+
stat_summary(aes(x=dpi, y=total_eye_score, color = temp), geom = "point", size=3)+
stat_summary(aes(x=dpi, y=total_eye_score, color = temp), geom = "errorbar", width=0.5)+
stat_summary(aes(x=dpi, y=total_eye_score, color = temp), geom = "line", width=0.25, alpha=0.5)+
scale_color_manual(values = temp_colors)+
labs(x="Days Post Inoculation", y="Total Eye Score", color="Temperature")
#set colors for temperature
temp_colors <- c("#277DA1", "#F94144")
#set color scheme MG treatment
treat_colors <- c("black", "#BC6C25")
# full factorial
treat_colors <- c("#277DA1", "#90BE6D", "#F94144", "#F9C74F")
range(ti.cont$quantity) #highest control quantity = 95.38
ti$quant_cutoff = 100
ti$seropos_cutoff = 0.061
ti$sympt_cutoff = 0.1
#Sample sizes
ti %>%
filter(dpi ==0)%>%
dplyr::select(treatment, temp, inf_temp)%>%
tbl_summary(
)%>%
modify_header(
label ~ "**All Birds**"
)
ti %>%
dplyr::select(dpi, treatment, temp, inf_temp)%>%
tbl_summary(
by=dpi
)%>%
modify_header(
label ~ "**All Days**"
)
#data frame with only inoculated birds on days with eye scores
ti.inoc <- ti%>%
filter(treatment == "Inoculated" & dpi %in% c(0, 3,7,9,14,18,21,24,28,35))
hist(ti.inoc$total_eye_score)
hist(ti$total_eye_score)
ti.inoc$sympt_cutoff = 0.5
ti.inoc$quant_cutoff = 22.5
#diseased = eye score
#infected = eye score or pathology >= cutoff
ti.inoc <- ti.inoc %>%
mutate(diseased= ifelse(total_eye_score>=sympt_cutoff, 1, 0),
sick = ifelse(total_eye_score>=sympt_cutoff | quantity >= quant_cutoff, 1, 0),
infected = ifelse(quantity >= quant_cutoff, 1, 0))
#new column with whether the bird is ever diseased
ti.inoc <- ti.inoc %>%
group_by(band_number) %>%
mutate(ever_diseased = ifelse(any(coalesce(diseased, 0) == 1), 1, 0),
ever_infected = ifelse(any(coalesce(infected, 0) == 1), 1, 0),
ever_sick = ifelse(any(coalesce(sick, 0) == 1), 1,0))%>%
ungroup()
#Sample sizes
#ever_diseased: cold n=6, warm n=8
#ever_infected: cold n=12, warm n=13
#Asymptomatic: cold n=6, warm n=5
ti.inoc %>%
filter(dpi ==28)%>%
dplyr::select(temp, ever_diseased, ever_infected, ever_sick)%>%
tbl_summary(
by=temp
)%>%
modify_header(
label ~ "**Inoculated Birds**"
)
#Source Eye Score Formatting
source("dataCleaning_eyeScore.R")
#Ordinal Mixed Effects Model
#Sham birds did not get infected therefore did not have eyescores. Remove from analysis so that model converges.
#No eye score on DPI 3 so also remove. Keep DPI 0 as reference category.
ti.mod <- ti %>%
dplyr::select(date, dpi, band_number, bird_ID, treatment, temp, total_eye_score)%>%
filter(treatment != "Sham" & dpi %in% c(0, 7,9,14,18,21,24,28))%>%
mutate(temp = relevel(factor(temp), ref = "Warm"),
dpi_f  = factor(dpi, levels = c(0,7,9,14,18,21,24,28)))
#We need to define thresholds based off of the observed data. The technical bounds are [0,6], but we only have [0,4]
levels_obs <- sort(unique(ti.mod$total_eye_score))
#turn observed numeric scores into an ordered factor with factors
ti.mod$eye_score_ord <- ordered(
ti.mod$total_eye_score,
levels=levels_obs
)
with(ti.mod, xtabs(~ eye_score_ord + temp + dpi_f))
ti.mod <- ti.mod |>
mutate(eye5 = fct_collapse(eye_score_ord,
"0"="0",
"1"=c("0.5","1"),
"2"=c("1.5","2"),
"3"=c("2.5","3"),
"4"=c("3.5","4")))
ti.mod <- ti.mod %>%
mutate(
dpi_f = relevel(dpi_f, ref = "0"),
temp  = relevel(temp,  ref = "Warm")
)
#Model Comparisons
clm.a <- clmm(eye_score_ord ~ temp * dpi_f + (1|band_number),
data=ti.mod,
link = "logit")
clm.b <- clmm(eye5 ~ temp * dpi_f + (1|band_number),
data=ti.mod,
link = "logit")
clm.c <- clmm(eye_score_ord ~ temp + dpi_f + (1|band_number),
data=ti.mod,
link = "logit")
clm.d <- clmm(eye5 ~ temp + dpi_f + (1|band_number),
data=ti.mod,
link = "logit")
summary(clm.a)
summary(clm.b)
summary(clm.c)
summary(clm.d)
aictab(cand.set=list(clm.a, clm.c),
modnames= c("clm.a", "clm.c"))
aictab(cand.set=list(clm.b, clm.d),
modnames= c("clm.b", "clm.d"))
#can't directly compare, but lower AIC = good
AIC(clm.c, clm.d)
#Lower logLikelihood = good
logLik(clm.c)
logLik(clm.d)
#R2 same if not slightly better = good
r2_nakagawa(clm.c)
r2_nakagawa(clm.d)
#predictions look the same
emmip(clm.c, temp ~ dpi_f)
emmip(clm.d, temp ~ dpi_f)
#use eye5 in final model
clm1 <- clmm(eye5 ~ temp + dpi_f + (1|band_number),
data=ti.mod,
link = "logit")
summary(clm1)
ti.mod <- ti.mod %>%
mutate(
eye5_num = as.numeric(as.character(eye5)),               # 0..4
dpi_num  = as.numeric(as.character(dpi_f))               # e.g., 0,7,9,14,...
)
# 2) Model predictions: expected category (mean class) + 95% CIs
emm_mean <- emmeans(clm1, ~ temp * dpi_f,
type = "response", mode = "mean.class") |>
as.data.frame() |>
mutate(
yhat = estimate - 1,
ymin = asymp.LCL - 1,
ymax = asymp.UCL - 1,
dpi_num = as.numeric(as.character(dpi_f))
)
ggplot() +
# raw observations
geom_jitter(
data = ti.mod,
aes(x = dpi_num, y = eye5_num, color = temp),
width = 0.6, height = 0.08, alpha = 0.35, size = 1.7
) +
# model mean class with CI
geom_errorbar(
data = emm_mean,
aes(x = dpi_num, ymin = ymin, ymax = ymax, color = temp),
width = 0.8, size = 0.5
) +
geom_line(
data = emm_mean,
aes(x = dpi_num, y = yhat, color = temp, group = temp),
size = 0.7
) +
geom_point(
data = emm_mean,
aes(x = dpi_num, y = yhat, color = temp),
size = 2.5
) +
scale_y_continuous(breaks = 0:4, limits = c(-1, 4.1)) +
labs(x = "Days Post Inoculation", y = "Total Eye Score",
color = "Temperature") +
theme_minimal(base_size = 12)
ggplot(ti.inoc, aes(x=dpi, y=total_eye_score, color=temp))+
geom_jitter(width=0.5, height=0.1, alpha=0.25)+
#geom_line(aes(group = band_number), alpha=0.25)+
stat_summary(aes(x=dpi, y=total_eye_score, color = temp), geom = "point", size=3)+
stat_summary(aes(x=dpi, y=total_eye_score, color = temp), geom = "errorbar", width=0.5)+
stat_summary(aes(x=dpi, y=total_eye_score, color = temp), geom = "line", width=0.25, alpha=0.5)+
scale_color_manual(values = temp_colors)+
labs(x="Days Post Inoculation", y="Total Eye Score", color="Temperature")
####Phagocytosis####
source("dataCleaning_phago.R")
ti.p$temp <- as.factor(ti.p$temp)
ti.p$treatment <- as.factor(ti.p$treatment)
ti.p <- ti.p %>%
mutate(
temp      = relevel(temp, ref = "Warm"),        # or whichever baseline you want
treatment = relevel(treatment, ref = "Sham") # change as needed
)
glm4 <- glmmTMB(phago_score~temp+treatment + (1|band_number),
weights=wbc_total+phago_total,
data=ti.p, family="binomial")
simulateResiduals(glm4, plot = T)
summary(glm4)
plot(allEffects(glm4))
#Anova type II asks whether there is a main effect overall, averaged across the other variables
glm4_anova_II <- car::Anova(glm4, type = "II")
glm4_anova_III <- car::Anova(glm4, type = "III")
#emmeans
emm <- emmeans(glm4, ~ temp * treatment, type = "response", re.form = NA)
emm_df <- as.data.frame(emm)
ggplot(emm_df, aes(x = treatment, y = prob, color=treatment))+
geom_point(size=2)+
geom_errorbar(aes(ymin = asymp.LCL, ymax = asymp.UCL, y=prob), width=0.1)+
geom_jitter(data = ti.p, aes(x = treatment, y = phago_score, color = treatment),
width = 0.1, alpha = 0.5, size=2)+
labs(x="Treatment", y="Phagocytosis Score", color="Treatment")+
scale_color_manual(values=treat_colors)+
facet_wrap(~temp)
ggplot(emm_df, aes(x = treatment, y = prob, color=treatment))+
geom_point(size=2)+
geom_errorbar(aes(ymin = asymp.LCL, ymax = asymp.UCL, y=prob), width=0.1)+
geom_jitter(data = ti.p, aes(x = treatment, y = phago_score, color = treatment),
width = 0.1, alpha = 0.5, size=2)+
labs(x="Treatment", y="Phagocytosis Score", color="Treatment")+
scale_color_manual(values=treat_colors)+
facet_wrap(~temp)
#set color scheme MG treatment
inoc_colors <- c("black", "#BC6C25")
ggplot(emm_df, aes(x = treatment, y = prob, color=treatment))+
geom_point(size=2)+
geom_errorbar(aes(ymin = asymp.LCL, ymax = asymp.UCL, y=prob), width=0.1)+
geom_jitter(data = ti.p, aes(x = treatment, y = phago_score, color = treatment),
width = 0.1, alpha = 0.5, size=2)+
labs(x="Treatment", y="Phagocytosis Score", color="Treatment")+
scale_color_manual(values=treat_colors)+
facet_wrap(~temp)
ggplot(emm_df, aes(x = treatment, y = prob, color=treatment))+
geom_point(size=2)+
geom_errorbar(aes(ymin = asymp.LCL, ymax = asymp.UCL, y=prob), width=0.1)+
geom_jitter(data = ti.p, aes(x = treatment, y = phago_score, color = treatment),
width = 0.1, alpha = 0.5, size=2)+
labs(x="Treatment", y="Phagocytosis Score", color="Treatment")+
scale_color_manual(values=inoc_colors)+
facet_wrap(~temp)
ggplot(emm_df, aes(x = treatment, y = prob, color=treatment))+
geom_point(size=3)+
geom_errorbar(aes(ymin = asymp.LCL, ymax = asymp.UCL, y=prob), width=0.1)+
geom_jitter(data = ti.p, aes(x = treatment, y = phago_score, color = treatment),
width = 0.1, alpha = 0.5, size=3)+
labs(x="Treatment", y="Phagocytosis Score", color="Treatment")+
scale_color_manual(values=inoc_colors)+
facet_wrap(~temp)
ggplot(emm_df, aes(x = treatment, y = prob, color=treatment))+
geom_point(size=3)+
geom_errorbar(aes(ymin = asymp.LCL, ymax = asymp.UCL, y=prob), width=0.1)+
geom_jitter(data = ti.p, aes(x = treatment, y = phago_score, color = treatment),
width = 0.1, alpha = 0.4, size=3)+
labs(x="Treatment", y="Phagocytosis Score", color="Treatment")+
scale_color_manual(values=inoc_colors)+
facet_wrap(~temp)
ggplot(emm_df, aes(x = treatment, y = prob, color=treatment))+
geom_point(size=3)+
geom_errorbar(aes(ymin = asymp.LCL, ymax = asymp.UCL, y=prob), width=0.1)+
geom_jitter(data = ti.p, aes(x = treatment, y = phago_score, color = treatment),
width = 0.1, alpha = 0.3, size=3)+
labs(x="Treatment", y="Phagocytosis Score", color="Treatment")+
scale_color_manual(values=inoc_colors)+
facet_wrap(~temp)
